<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Quiz Game</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; }
    textarea, input { font-size: 16px; }
    .question-box, .answer-box { width: 100%; margin: 10px 0; }
    .controls, .scores { margin: 15px 0; }
    button { margin: 5px; padding: 8px 16px; font-size: 16px; }
    .scores span { display: inline-block; width: 120px; }
  </style>
</head>
<body>
  <h1>Quiz Game</h1>

  <!-- データ読み込み -->
  <div>
    <h3>問題データの読み込み</h3>
    <input type="file" id="excelUpload" accept=".xlsx" />
    <button onclick="uploadExcel()">Excelから読み込む</button>
    <br><br>
    <input type="text" id="sheetUrl" placeholder="スプレッドシートのCSV URLを入力" style="width:70%">
    <button onclick="loadFromSpreadsheet(document.getElementById('sheetUrl').value)">スプレッドシートから読み込む</button>
  </div>

  <!-- 問題と回答表示 -->
  <div>
    <textarea id="questionBox" class="question-box" rows="4" readonly></textarea>
    <textarea id="answerBox" class="answer-box" rows="2" readonly></textarea>
  </div>

  <!-- コントロール -->
  <div class="controls">
    <button onclick="nextQuestion()">出題</button>
    <button onclick="buzz('A')">A早押し</button>
    <button onclick="buzz('B')">B早押し</button>
    <button onclick="showAnswer()">答え表示</button>
    <button onclick="markCorrect()">正解</button>
    <button onclick="markWrong()">不正解</button>
    <button onclick="resetScores()">スコアリセット</button>
  </div>

  <!-- スコア表示 -->
  <div class="scores">
    <h3>スコア</h3>
    <span>A 正解: <span id="aCorrect">0</span></span>
    <span>A 不正解: <span id="aWrong">0</span></span><br>
    <span>B 正解: <span id="bCorrect">0</span></span>
    <span>B 不正解: <span id="bWrong">0</span></span>
  </div>

  <!-- ライブラリ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    let questions = []; // {q, a} の配列
    let currentIndex = -1;
    let turn = null; // "A" または "B"
    let scores = { A: { correct: 0, wrong: 0 }, B: { correct: 0, wrong: 0 } };
    let typingTimer = null; // タイピング制御用
    let typingStopped = false; // 途中で止めたかどうか

    // Excel読み込み
    function uploadExcel() {
      const file = document.getElementById("excelUpload").files[0];
      if (!file) { alert("ファイルを選択してください"); return; }
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, {header:1});
        questions = rows.slice(1).map(r => ({q: r[0], a: r[1]}));
        alert("Excelから問題を読み込みました！");
      };
      reader.readAsArrayBuffer(file);
    }

    // スプレッドシートCSV読み込み
    async function loadFromSpreadsheet(url) {
      try {
        const response = await fetch(url);
        const text = await response.text();
        const rows = text.trim().split("\n").map(line => line.split(","));
        questions = rows.slice(1).map(r => ({q: r[0], a: r[1]}));
        alert("スプレッドシートから読み込みました！");
      } catch (e) {
        alert("スプレッドシートの読み込みに失敗しました");
      }
    }

    // 出題
    function nextQuestion() {
      if (questions.length === 0) { alert("問題が読み込まれていません"); return; }
      currentIndex++;
      if (currentIndex >= questions.length) { alert("すべての問題が終了しました"); return; }
      document.getElementById("questionBox").value = "";
      document.getElementById("answerBox").value = "";
      turn = null;
      typingStopped = false;
      typeWriter(questions[currentIndex].q, "questionBox", 0);
    }

    // タイピング風に表示（スピードを遅めに: 100ms）
    function typeWriter(text, elementId, i) {
      if (typingStopped) return; // 止められていたら終了
      if (i < text.length) {
        document.getElementById(elementId).value += text.charAt(i);
        typingTimer = setTimeout(() => typeWriter(text, elementId, i+1), 100);
      }
    }

    // 早押し
    function buzz(player) {
      if (!turn) {
        turn = player;
        typingStopped = true; // タイピングを停止
        clearTimeout(typingTimer);
        document.getElementById("questionBox").value += `/`;
      }
    }

    // 答え表示
    function showAnswer() {
      if (currentIndex >= 0) {
        // 答えを表示
        document.getElementById("answerBox").value = questions[currentIndex].a;
        // 残りの問題文を強制表示
        document.getElementById("questionBox").value = questions[currentIndex].q;
      }
    }

    // 正解
    function markCorrect() {
      if (!turn) return;
      scores[turn].correct++;
      updateScores();
      turn = null;
      setTimeout(() => nextQuestion(), 500);
    }

    // 不正解
    function markWrong() {
      if (!turn) return;
      scores[turn].wrong++;
      updateScores();
      turn = null;
      setTimeout(() => nextQuestion(), 500);
    }

    // スコア表示更新
    function updateScores() {
      document.getElementById("aCorrect").innerText = scores.A.correct;
      document.getElementById("aWrong").innerText = scores.A.wrong;
      document.getElementById("bCorrect").innerText = scores.B.correct;
      document.getElementById("bWrong").innerText = scores.B.wrong;
    }

    // スコアリセット
    function resetScores() {
      scores = { A: { correct: 0, wrong: 0 }, B: { correct: 0, wrong: 0 } };
      updateScores();
    }
  </script>
</body>
</html>

