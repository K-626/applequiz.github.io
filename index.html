<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Quiz Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background-color: #f8f9fa;
      padding-top: 40px;
    }
    textarea {
      resize: none;
    }
    .question-box, .answer-box {
      font-size: 1.1rem;
      font-family: monospace;
    }
    .card {
      border-radius: 1rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .scores span {
      display: inline-block;
      min-width: 150px;
    }

    /* モバイル用大きな早押しボタン */
    .mobile-buzzer {
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1050;
      display: none; /* JSで表示制御 */
      padding: 0.7rem 2.2rem;
      font-size: 1.25rem;
      box-shadow: 0 6px 18px rgba(0,0,0,0.18);
      border-radius: 30%;
      width: 120px;              /* 横幅（例：120px） */
      height: 120px;             /* 縦幅（例：120px） */
      background-color: #1b4ac2; /* 背景色（例：赤） */
      color: white;              /* 文字色 */
      border: none;              /* 枠線なし */
      font-size: 1.5rem;         /* 文字の大きさ */
      font-weight: bold;         /* 太字 */
        
    }
    .mobile-control {
      position: fixed;
      bottom: 18px;
      z-index: 1050;
      display: none;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      font-size: 1.3rem;
      font-weight: bold;
      border: none;
      color: white;
      box-shadow: 0 6px 18px rgba(0,0,0,0.18); 
      transition: transform 0.1s, filter 0.1s;
    }
    .mobile-left {
      left: 12%;
      background-color: #28a745; /* 緑：出題 */
    }
    .mobile-center {
      left: 50%;
      transform: translateX(-50%);
      background-color: #50e0a0; /* Aボタン（あなたの指定色） */
    }
    .mobile-right {
      right: 12%;
      background-color: #007bff; /* 青：答表示 */
    }

   

    /* 小さい画面向けに少し大きめのタップ領域 */
   @media (max-width: 480px) {
    .mobile-buzzer,
    .mobile-control {
      width: 110px;
      height: 110px;
      font-size: 1.4rem;
    }
  }
  </style>
</head>
<body>

  <div class="container">
    <h1 class="text-center mb-4 fw-bold">Quiz Game</h1>

    <!-- データ読み込み -->
    <div class="card p-4 mb-4">
      <h4 class="mb-3">問題データの読み込み</h4>

      <!-- ファイル選択とボタンを横並び -->
      <div class="input-group mb-2">
        <input type="file" class="form-control" id="excelUpload" accept=".xlsx">
        <button class="btn btn-sm btn-primary" onclick="uploadExcel()">Excelから読み込む</button>
      </div>

      
      <div class="form-check form-switch mt-2">
        <input class="form-check-input" type="checkbox" id="comCheckbox" onchange="toggleCOM()">
        <label class="form-check-label" for="comCheckbox">COM 対戦</label>
      </div>
      <div class="form-check form-switch mt-2">
        <input class="form-check-input" type="checkbox" id="randomMode">
        <label class="form-check-label" for="randomMode">ランダム出題</label>
      </div>

      <!-- モバイル早押しの切り替え -->
      <div class="form-check form-switch mt-2">
        <input class="form-check-input" type="checkbox" id="mobileBuzzerCheckbox" onchange="toggleMobileBuzzerVisibility()">
        <label class="form-check-label" for="mobileBuzzerCheckbox">ボタン</label>
      </div>
    </div>

    <!-- 問題と回答 -->
    <div class="card p-4 mb-4">
      <div class="mb-3">
        <label class="form-label fw-bold">問題</label>
        <textarea id="questionBox" class="form-control question-box" rows="4" readonly></textarea>
      </div>
      <div class="mb-3">
        <label class="form-label fw-bold">答え</label>
        <textarea id="answerBox" class="form-control answer-box" rows="2" readonly></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label fw-bold">COMの解答結果</label>
        <textarea id="comResultBox" class="form-control" rows="1" readonly></textarea>
      </div>
      <div class="mb-3">
        <label class="form-label fw-bold">誰が押したか</label>
        <textarea id="buzzResultBox" class="form-control" rows="2" readonly></textarea>
      </div>
    </div>

    <!-- コントロール -->
    <div class="card p-4 mb-4 text-center">
      <div class="d-flex flex-wrap justify-content-center gap-2">
        <button class="btn btn-success" onclick="nextQuestion()">出題</button>
        <button class="btn btn-outline-primary" onclick="buzz('A')">A 早押し</button>
        <button class="btn btn-outline-warning" onclick="buzz('B')">B 早押し</button>
        <button class="btn btn-info" onclick="showAnswer()">答え表示</button>
        <button class="btn btn-success" onclick="markCorrect()">正解</button>
        <button class="btn btn-danger" onclick="markWrong()">不正解</button>
        <button class="btn btn-info" onclick="resetScores()">スコアリセット</button>
      </div>
      <div class="text-muted mt-3 small">
        <kbd>Q</kbd> 出題 ／ <kbd>F</kbd> A押し ／ <kbd>J</kbd> B押し ／ <kbd>A</kbd> 答え表示 ／ <kbd>Z</kbd> 正解 ／ <kbd>X</kbd> 不正解 ／ <kbd>R</kbd> リセット
      </div>
    </div>

    <!-- スコア表示 -->
    <div class="card p-4 mb-4">
      <h4 class="mb-3">スコア</h4>
      <div class="row">
        <div class="col-md-4 mb-2">
          <h5>Aプレイヤー</h5>
          <span>正解: <span id="aCorrect">0</span></span><br>
          <span>不正解: <span id="aWrong">0</span></span>
        </div>
        <div class="col-md-4 mb-2">
          <h5>Bプレイヤー</h5>
          <span>正解: <span id="bCorrect">0</span></span><br>
          <span>不正解: <span id="bWrong">0</span></span>
        </div>
        <div class="col-md-4 mb-2">
          <h5>COM</h5>
          <span>正解: <span id="comCorrect">0</span></span><br>
          <span>不正解: <span id="comWrong">0</span></span>
        </div>
      </div>
    </div>
  </div>

<!-- モバイル用 丸い出題＆答え表示ボタン -->
   <button id="mobileNextBtn" class="mobile-control mobile-left" onclick="nextQuestion()">出題</button>
   <button id="mobileAnswerBtn" class="mobile-control mobile-right" onclick="showAnswer()">答表示</button>

<!-- 既存のA早押しボタン -->
   <button id="mobileBuzzer" class="mobile-buzzer mobile-center" onclick="buzz('A')" aria-label="A早押しボタン">A</button>

  <!-- ライブラリ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let questions = [];
    let currentIndex = -1;
    let turn = null;
    let scores = { A: { correct: 0, wrong: 0 }, B: { correct: 0, wrong: 0 }, COM: { correct: 0, wrong: 0 } };
    let typingTimer = null;
    let typingStopped = false;
    let comTimer = null;
    let isCOM = false;
    let usedIndices = [];

    function toggleCOM() {
      isCOM = document.getElementById("comCheckbox").checked;
    }

    function uploadExcel() {
      const file = document.getElementById("excelUpload").files[0];
      if (!file) return alert("ファイルを選択してください");
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, {header:1});
        questions = rows.slice(1).map(r => ({q: r[0], a: r[1]}));
        alert("Excelから問題を読み込みました！");
      };
      reader.readAsArrayBuffer(file);
    }

    function nextQuestion() {
      if (questions.length === 0) return alert("問題が読み込まれていません");
      const randomMode = document.getElementById("randomMode").checked;

      if (randomMode) {
        if (usedIndices.length >= questions.length) return alert("すべての問題が終了しました");
        let idx;
        do { idx = Math.floor(Math.random() * questions.length); } while (usedIndices.includes(idx));
        usedIndices.push(idx);
        currentIndex = idx;
      } else {
        currentIndex++;
        if (currentIndex >= questions.length) return alert("すべての問題が終了しました");
      }

      document.getElementById("questionBox").value = "";
      document.getElementById("answerBox").value = "";
      document.getElementById("comResultBox").value = "";
      document.getElementById("buzzResultBox").value = "";
      turn = null;
      typingStopped = false;
      clearTimeout(comTimer);
      typeWriter(questions[currentIndex].q, "questionBox", 0);

      if (isCOM) {
        const qLength = questions[currentIndex].q.length;
        const displayTime = qLength * 100;
        const rand1 = Math.random();
        if (rand1 >= 0.2) {
          const randomDelay = Math.floor(displayTime * rand1);
          comTimer = setTimeout(() => {
            if (!turn && currentIndex >= 0) {
              buzz("COM");
              const rand2 = Math.random();
              const sum = rand1 + rand2;
              setTimeout(() => {
                if (sum > 0.5) {
                  document.getElementById("comResultBox").value = "COM: 正解！";
                  showAnswer();
                  updateScore("COM", true);
                } else {
                  document.getElementById("comResultBox").value = "COM: 不正解…";
                  showAnswer();
                  updateScore("COM", false);
                }
              }, 1000);
            }
          }, randomDelay);
        }
      }
    }

    function typeWriter(text, elementId, i) {
      if (typingStopped) return;
      if (i < text.length) {
        document.getElementById(elementId).value += text.charAt(i);
        typingTimer = setTimeout(() => typeWriter(text, elementId, i+1), 100);
      }
    }

    function buzz(player) {
      if (!turn) {
        turn = player;
        typingStopped = true;
        clearTimeout(typingTimer);
        clearTimeout(comTimer);
        document.getElementById("questionBox").value += "/";
        document.getElementById("buzzResultBox").value = `${player} が押しました！`;
      }
    }

    function showAnswer() {
      if (currentIndex >= 0) {
        document.getElementById("answerBox").value = questions[currentIndex].a;
        document.getElementById("questionBox").value = questions[currentIndex].q;
      }
    }

    function markCorrect() {
      if (!turn) return;
      scores[turn].correct++;
      updateScores();
      turn = null;
      setTimeout(() => nextQuestion(), 500);
    }

    function markWrong() {
      if (!turn) return;
      scores[turn].wrong++;
      updateScores();
      turn = null;
      setTimeout(() => nextQuestion(), 500);
    }

    function updateScore(player, isCorrect) {
      if (isCorrect) scores[player].correct++;
      else scores[player].wrong++;
      updateScores();
    }

    function updateScores() {
      document.getElementById("aCorrect").innerText = scores.A.correct;
      document.getElementById("aWrong").innerText = scores.A.wrong;
      document.getElementById("bCorrect").innerText = scores.B.correct;
      document.getElementById("bWrong").innerText = scores.B.wrong;
      document.getElementById("comCorrect").innerText = scores.COM.correct;
      document.getElementById("comWrong").innerText = scores.COM.wrong;
    }

    function resetScores() {
      scores = { A: { correct: 0, wrong: 0 }, B: { correct: 0, wrong: 0 }, COM: { correct: 0, wrong: 0 } };
      updateScores();
    }

    // --- モバイル早押しの表示制御 ---
    function toggleMobileBuzzerVisibility() {
      const cb = document.getElementById("mobileBuzzerCheckbox");
      const buzzerBtn = document.getElementById("mobileBuzzer");
      const nextBtn = document.getElementById("mobileNextBtn");
      const answerBtn = document.getElementById("mobileAnswerBtn");
  
      const show = cb.checked && window.innerWidth <= 768;
      [buzzerBtn, nextBtn, answerBtn].forEach(btn => {
        btn.style.display = show ? "block" : "none";
      });
    }


    // 画面リサイズ時にも表示状態を切り替える
    window.addEventListener("resize", toggleMobileBuzzerVisibility);
    document.addEventListener("DOMContentLoaded", () => {
      // 初期状態反映
      toggleMobileBuzzerVisibility();
    });

    // キーボード操作
    document.addEventListener("keydown", e => {
      switch (e.key) {
        case "q": nextQuestion(); break;
        case "f": buzz("A"); break;
        case "j": buzz("B"); break;
        case "a": showAnswer(); break;
        case "z": markCorrect(); break;
        case "x": markWrong(); break;
        case "r": resetScores(); break;
      }
    });
  </script>
</body>
</html>
