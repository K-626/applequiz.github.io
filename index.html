<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Quiz </title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; }
    textarea, input { font-size: 16px; }
    .question-box, .answer-box { width: 100%; margin: 10px 0; }
    .controls, .scores { margin: 15px 0; }
    button { margin: 5px; padding: 8px 16px; font-size: 16px; }
    .scores span { display: inline-block; width: 140px; }
  </style>
</head>
<body>
  <h1>Quiz Game</h1>

  <!-- ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ -->
  <div>
    <h3>å•é¡Œãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿</h3>
    <input type="file" id="excelUpload" accept=".xlsx" />
    <button onclick="uploadExcel()">Excelã‹ã‚‰èª­ã¿è¾¼ã‚€</button>
    <br><br>
  </div>
  <label>
    <input type="checkbox" id="comCheckbox" onchange="toggleCOM()"> COM
  </label>
  <div>
  <label><input type="checkbox" id="randomMode"> random</label>
  </div>

  <!-- å•é¡Œã¨å›ç­”è¡¨ç¤º -->
  <div>
    <textarea id="questionBox" class="question-box" rows="4" readonly></textarea>
    <textarea id="answerBox" class="answer-box" rows="2" readonly></textarea>
  </div>
  <div>
  <label>COMã®è§£ç­”çµæœ</label><br>
  <textarea id="comResultBox" rows="1" cols="50" readonly></textarea>
  </div>
    <div>
    <label>èª°ãŒæŠ¼ã—ãŸã‹</label><br>
    <textarea id="buzzResultBox" rows="2" cols="50" readonly></textarea>
  </div>

  <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
  <div class="controls">
    <button onclick="nextQuestion()">å‡ºé¡Œ</button>
    <button onclick="buzz('A')">Aæ—©æŠ¼ã—</button>
    <button onclick="buzz('B')">Bæ—©æŠ¼ã—</button>
    <button onclick="showAnswer()">ç­”ãˆè¡¨ç¤º</button>
    <button onclick="markCorrect()">æ­£è§£</button>
    <button onclick="markWrong()">ä¸æ­£è§£</button>
    <button onclick="resetScores()">ã‚¹ã‚³ã‚¢ãƒªã‚»ãƒƒãƒˆ</button>
  </div>

  <!-- ã‚¹ã‚³ã‚¢è¡¨ç¤º -->
  <div class="scores">
    <h3>ã‚¹ã‚³ã‚¢</h3>
    <span>A æ­£è§£: <span id="aCorrect">0</span></span>
    <span>A ä¸æ­£è§£: <span id="aWrong">0</span></span><br>
    <span>B æ­£è§£: <span id="bCorrect">0</span></span>
    <span>B ä¸æ­£è§£: <span id="bWrong">0</span></span><br>
    <span>COM æ­£è§£: <span id="comCorrect">0</span></span>
    <span>COM ä¸æ­£è§£: <span id="comWrong">0</span></span>
  </div>

  <!-- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    let questions = [];
    let currentIndex = -1;
    let turn = null;
    let scores = { 
      A: { correct: 0, wrong: 0 }, 
      B: { correct: 0, wrong: 0 },
      COM: { correct: 0, wrong: 0 }
    };
    let typingTimer = null;
    let typingStopped = false;
    let comTimer = null;
    let isCOM = false;
    let scoreCOM = { correct: 0, wrong: 0 };

    function toggleCOM() {
      isCOM = document.getElementById("comCheckbox").checked;
    }

    // Excelèª­ã¿è¾¼ã¿
    function uploadExcel() {
      const file = document.getElementById("excelUpload").files[0];
      if (!file) { alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, {header:1});
        questions = rows.slice(1).map(r => ({q: r[0], a: r[1]}));
        alert("Excelã‹ã‚‰å•é¡Œã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼");
      };
      reader.readAsArrayBuffer(file);
    }

    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆCSVèª­ã¿è¾¼ã¿
    async function loadFromSpreadsheet(url) {
      try {
        // ã‚·ãƒ¼ãƒˆIDæŠ½å‡º
        const match = url.match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
        if (!match) {
          alert("æœ‰åŠ¹ãªã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
          return;
        }
        const sheetId = match[1];

        // gid ã‹ã‚‰ã‚·ãƒ¼ãƒˆåã‚’å–å¾—ã™ã‚‹ã®ã¯é›£ã—ã„ã®ã§ã€ã¨ã‚Šã‚ãˆãšæœ€åˆã®ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚€
        // Google Sheets CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆURL
        const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv`;

        const response = await fetch(csvUrl);
        const text = await response.text();

        // åŒºåˆ‡ã‚Šæ–‡å­—ã‚’è‡ªå‹•åˆ¤å®š
        let delimiter = ",";
        if (text.includes("\t")) {
          delimiter = "\t";
        } else if (text.includes(";")) {
          delimiter = ";";
        }

        const rows = text.trim().split("\n").map(line => line.split(delimiter));
        questions = rows.slice(1).map(r => ({q: r[0], a: r[1]}));
        alert("ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰å•é¡Œã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼");

      } catch (e) {
        console.error(e);
        alert("ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
    }

let usedIndices = []; // å‡ºé¡Œæ¸ˆã¿ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨˜éŒ²

    function nextQuestion() {
      if (questions.length === 0) { 
        alert("å•é¡ŒãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“"); 
        return; 
      }

      const randomMode = document.getElementById("randomMode").checked;

      if (randomMode) {
        // ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰
        if (usedIndices.length >= questions.length) {
          alert("ã™ã¹ã¦ã®å•é¡ŒãŒçµ‚äº†ã—ã¾ã—ãŸ");
          return;
        }
        let idx;
        do {
          idx = Math.floor(Math.random() * questions.length);
        } while (usedIndices.includes(idx));
        usedIndices.push(idx);
        currentIndex = idx;
      } else {
        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰
        currentIndex++;
        if (currentIndex >= questions.length) {
          alert("ã™ã¹ã¦ã®å•é¡ŒãŒçµ‚äº†ã—ã¾ã—ãŸ");
          return;
        }
      }

      // å‡ºé¡Œå‡¦ç†ï¼ˆå…±é€šéƒ¨åˆ†ï¼‰
      document.getElementById("questionBox").value = "";
      document.getElementById("answerBox").value = "";
      document.getElementById("comResultBox").value = "";
      document.getElementById("buzzResultBox").value = "";
      turn = null;
      typingStopped = false;
      clearTimeout(comTimer);
      typeWriter(questions[currentIndex].q, "questionBox", 0);

      // COMå‡¦ç†ã¯ãã®ã¾ã¾
      if (isCOM) {
        const qLength = questions[currentIndex].q.length;
        const displayTime = qLength * 100;
        const rand1 = Math.random();
        if (rand1 < 0.2) {
          console.log("COMã¯ã“ã®å•é¡Œã§ã¯æŠ¼ã—ã¾ã›ã‚“");
        } else {
          const randomDelay = Math.floor(displayTime * rand1);
          comTimer = setTimeout(() => {
            if (!turn && currentIndex >= 0) {
              buzz("COM");
              const rand2 = Math.random();
              const sum = rand1 + rand2;
              setTimeout(() => {
                if (sum > 0.5) {
                  document.getElementById("comResultBox").value = "COM: æ­£è§£ï¼";
                  showAnswer();
                  updateScore("COM", true);
                } else {
                  document.getElementById("comResultBox").value = "COM: ä¸æ­£è§£â€¦";
                  showAnswer();
                  updateScore("COM", false);
                }
              }, 1000);
            }
          }, randomDelay);
        }
      }
    }

    // ã‚¿ã‚¤ãƒ”ãƒ³ã‚°é¢¨è¡¨ç¤º
    function typeWriter(text, elementId, i) {
      if (typingStopped) return;
      if (i < text.length) {
        document.getElementById(elementId).value += text.charAt(i);
        typingTimer = setTimeout(() => typeWriter(text, elementId, i+1), 100);
      }
    }

    // æ—©æŠ¼ã—
    // æ—©æŠ¼ã—
    function buzz(player) {
      if (!turn) {
        turn = player;
        typingStopped = true;
        clearTimeout(typingTimer);
        clearTimeout(comTimer);
        document.getElementById("questionBox").value += `/`;

        // æŠ¼ã—ãŸäººã‚’è¡¨ç¤º
        document.getElementById("buzzResultBox").value = player + " ãŒæŠ¼ã—ã¾ã—ãŸï¼";
      }
    }


    // ç­”ãˆè¡¨ç¤º
    function showAnswer() {
      if (currentIndex >= 0) {
        document.getElementById("answerBox").value = questions[currentIndex].a;
        document.getElementById("questionBox").value = questions[currentIndex].q;
      }
    }

    // æ­£è§£
    function markCorrect() {
      if (!turn) return;
      scores[turn].correct++;
      updateScores();
      turn = null;
      setTimeout(() => nextQuestion(), 500);
    }

    // ä¸æ­£è§£
    function markWrong() {
      if (!turn) return;
      scores[turn].wrong++;
      updateScores();
      turn = null;
      setTimeout(() => nextQuestion(), 500);
    }

    // ã‚¹ã‚³ã‚¢è¡¨ç¤ºæ›´æ–°
    function updateScore(player, isCorrect) {
      if (player === "A") {
        if (isCorrect) scoreA.correct++; else scoreA.wrong++;
        document.getElementById("aCorrect").innerText = scoreA.correct;
        document.getElementById("aWrong").innerText = scoreA.wrong;
      } else if (player === "B") {
        if (isCorrect) scoreB.correct++; else scoreB.wrong++;
        document.getElementById("bCorrect").innerText = scoreB.correct;
        document.getElementById("bWrong").innerText = scoreB.wrong;
      } else if (player === "COM") { // ğŸ‘ˆ è¿½åŠ 
        if (isCorrect) scoreCOM.correct++; else scoreCOM.wrong++;
        document.getElementById("comCorrect").innerText = scoreCOM.correct;
        document.getElementById("comWrong").innerText = scoreCOM.wrong;
      }
    }


    // ã‚¹ã‚³ã‚¢ãƒªã‚»ãƒƒãƒˆ
    function resetScores() {
      scores = { A: { correct: 0, wrong: 0 }, B: { correct: 0, wrong: 0 }, COM: { correct: 0, wrong: 0 } };
      updateScores();
    }
    document.addEventListener("keydown", (e) => {
  switch (e.key) {
    case "q": // å‡ºé¡Œ
      nextQuestion();
      break;
    case "f": // Aæ—©æŠ¼ã—
      buzz("A");
      break;
    case "j": // Bæ—©æŠ¼ã—
      buzz("B");
      break;
    case "a": // ç­”ãˆè¡¨ç¤º
      showAnswer();
      break;
    case "z": // æ­£è§£
      markCorrect();
      break;
    case "x": // ä¸æ­£è§£
      markWrong();
      break;
    case "r": // ã‚¹ã‚³ã‚¢ãƒªã‚»ãƒƒãƒˆ
      resetScores();
      break;
  }
});

  </script>
</body>
</html>
